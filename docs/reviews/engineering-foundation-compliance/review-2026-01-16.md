# Engineering Foundation 规范对齐检查报告（monorepo-skeleton）

日期：2026-01-16

## 范围与依据

- 检查范围：`apps/*`、`packages/*`、`tooling/*`、`docs/*`、`.github/*`、`.husky/*`、根配置文件
- 规范依据（engineering_foundation）：
  - `docs/00-quick-ref-for-ai.md`（MUST 速查）
  - `docs/01-project-structure/monorepo.md`
  - `docs/02-naming-conventions/naming-conventions.md`
  - `docs/03-typescript/typescript.md`
  - `docs/04-quality-gate/quality-gate.md`
  - `docs/05-git-workflow/git-workflow.md`
  - `docs/06-api-design/api-design.md` + `docs/20-architecture-decisions/adr-api-001-unified-api-contract.md`
  - `docs/07-environment/env-management.md` + `docs/20-architecture-decisions/adr-env-001-app-env-canonical.md`
  - `docs/11-observability/observability.md`
  - `docs/12-security/security.md` + `docs/20-architecture-decisions/adr-auth-001-auth-transport-cookie-vs-bearer.md`
  - `docs/20-architecture-decisions/adr-id-001-public-id-vs-internal-id.md`
  - `docs/20-architecture-decisions/adr-monorepo-001-shared-code-packages-only.md`

## 总体结论

对照 MUST 级别条款完成检查后，已将仓库改造成满足工程基线要求：

- Monorepo 目录结构、文档目录结构、质量闸门（hook + CI）、ENV 基线、API 契约（统一响应 + TraceId + 分页）、前端模块边界与导入规范均已对齐。
- 本次改造后本地质量门禁验证通过：`format:check`、`lint:ci`、`typecheck`、`test`、`build`（miniprogram 按根脚本默认排除）。

## 逐条对照（MUST）

### 1) Monorepo 结构（monorepo.md / ADR-MONOREPO-001）

- 规则：应用放 `apps/*`；共享运行时代码放 `packages/*`；共享构建期配置放 `tooling/*`；`apps/*` 之间禁止直接依赖。
- 现状：目录结构符合；apps 未互相依赖；共享包维持无框架强绑定（`shared-*` 仅承载通用类型/工具）。

### 2) docs/ 文档目录规范（monorepo.md）

- 规则：根目录必须提供 `docs/`，并按职能分层：`requirements/`、`design/`、`reviews/`、`testing/`、`runbooks/`、`changelog/`。
- 改造：已整理为上述目录结构，并补齐各目录的 `README.md` 索引。
- 同步：修复了文档迁移后遗留的旧路径链接（例如 `docs/development/*`、`docs/deployment/*`、`docs/ONBOARDING.md` 等）。

### 3) 命名规范（naming-conventions.md）

- 规则：目录/文件默认 `kebab-case`；React 组件文件允许 `PascalCase.tsx`；Hooks 允许 `useXxx.ts`；工具约定允许 `__tests__` 等目录；Prisma migration 名称使用 `snake_case`。
- 改造：
  - 前端非组件文件统一为 `kebab-case`（示例：stores、utils）。
  - Server 文档与 features/backlog 归档文件统一为 `kebab-case`。
- 例外说明：
  - `.github/pull_request_template.md` 属 GitHub 约定文件名（git-workflow.md 模板指定）。
  - Prisma migration 目录名包含下划线属规范允许的 `snake_case`（data-layer.md R8）。

### 4) TypeScript（typescript.md）

- 规则：`strict: true`；纯类型使用 `export type` / `import type`；`MUST NOT any`（允许在“第三方库缺失/过渡期”下用注释说明的例外）。
- 改造：
  - 后端部分文件补齐 `import type`，降低运行时引入风险。
  - 根 `tsconfig.json` 对齐“共享基线 + 各应用覆盖”的组织方式。

### 5) 环境变量（env-management.md / ADR-ENV-001）

- 规则：按应用存放 `.env.example`；禁止提交真实 `.env*`；必须产出统一语义 `APP_ENV=dev|staging|prod`；启动时 schema 校验（fail-fast）。
- 现状/改造：
  - `apps/*/.env.example` 已补齐（包含 miniprogram）。
  - Admin/WWW（Vite）将 `VITE_APP_ENV` 映射为 `APP_ENV` 常量并校验。
  - Server 使用 Zod schema 校验并强制 `APP_ENV` 语义。
  - Miniprogram（Taro）通过构建期注入 `APP_ENV` 并在运行时做校验。

### 6) API 设计（ADR-API-001）

- 规则：统一响应 `{code, message, data}`；分页参数 `page + pageSize`；前端必须注入 `X-Trace-Id`，401/403 以 HTTP status 判定。
- 现状/改造：
  - Server：全局响应包装与异常格式已对齐统一契约；分页 DTO 使用 `pageSize`。
  - Admin/WWW：请求封装统一注入 `X-Trace-Id`、使用 Cookie 鉴权（`credentials: include`）、并解包 `{code,message,data}`。

### 7) 质量闸门（quality-gate.md）

- 规则：pre-commit（lint-staged）+ commit-msg（commitlint）；CI 必须跑 `format:check + lint + typecheck + test + build` 并阻断合并；PR 标题遵循 Conventional Commits。
- 改造：
  - Husky hooks 对齐 v9 规范（正确加载 husky bootstrap）。
  - 根 CI 工作流补齐质量门禁步骤；新增 PR title/branch 规范校验工作流。

### 8) 可观测性（observability.md）

- 规则：Trace ID 全链路；服务端日志包含 `timestamp/level/message/traceId/service`；前端每请求注入 `X-Trace-Id`。
- 现状/改造：
  - Server：使用 pino http 的 `genReqId` 复用/生成 TraceId，并写回 `X-Trace-Id` 响应头。
  - 前端：请求封装为每次请求生成 TraceId（不落地 localStorage）。

### 9) 安全（security.md / ADR-AUTH-001）

- 规则：Web 默认 Cookie 鉴权；对 Cookie 鉴权的写操作必须做 CSRF 防护；敏感信息不得日志明文输出。
- 现状/改造：
  - Server：全局 CSRF Guard（Origin/Referer 校验）仅对 Cookie 鉴权的写请求生效；并保留 Bearer 请求的兼容豁免。
  - 审计日志对敏感字段脱敏（`[REDACTED]`）。

## 验证命令（本地）

在仓库根目录执行：

```bash
pnpm format:check
pnpm lint:ci
pnpm typecheck
pnpm test
pnpm build
```

（miniprogram 默认由根脚本排除，避免工具链兼容性引发的全仓库阻断。）

## 待确认/可选改进

- OpenAPI 生成代码目录内仍存在相对路径导入（生成器输出），如需“业务代码 + 生成代码”统一约束，可进一步调整生成器配置或为生成目录加例外规则。
- 文档内仍保留 `{{TITLE}}/{{DOMAIN}}` 等模板占位符（适用于 skeleton 初始化流程）；若要作为真实项目落地，建议在初始化脚本中一次性替换为真实值。

# Code Review 清单

## 审查流程

### PR 提交者职责

1. **自查清单**（提交前必须完成）
   - [ ] 通过 `pnpm lint` 和 `pnpm typecheck`
   - [ ] 新功能有对应测试
   - [ ] 更新相关文档
   - [ ] PR 描述清晰完整

2. **PR 描述模板**
   ```markdown
   ## 变更说明
   - 简述做了什么变更
   - 为什么要做这个变更

   ## 测试计划
   - [ ] 单元测试
   - [ ] 手动测试步骤

   ## 截图（如有 UI 变更）
   ```

### 审查者职责

1. 理解变更目的
2. 按清单逐项检查
3. 给出建设性反馈
4. 及时响应（24h 内）

---

## 通用检查项

### 代码质量

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 无 `any` | 除非有注释说明 | 🔴 阻塞 |
| 无 `console.log` | 使用 Logger | 🔴 阻塞 |
| 无魔法数字 | 抽取常量/枚举 | 🟡 建议修复 |
| 函数 < 50 行 | 过长需拆分 | 🟡 建议修复 |
| 命名有意义 | 见名知意 | 🟡 建议修复 |
| 注释必要处 | 复杂逻辑需解释"为什么" | 🟢 建议 |

### 安全检查

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 无敏感信息硬编码 | 密码、密钥、Token | 🔴 阻塞 |
| 无敏感信息日志 | 不打印密码/Token | 🔴 阻塞 |
| 输入已校验 | Zod 校验 body/query/param | 🔴 阻塞 |
| SQL 注入防护 | 使用 Prisma 参数化 | 🔴 阻塞 |
| XSS 防护 | 用户输入已转义 | 🔴 阻塞 |

### 测试检查

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 新功能有测试 | 至少覆盖核心路径 | 🟡 建议修复 |
| 测试覆盖异常 | 至少一个异常分支 | 🟡 建议修复 |
| 测试命名清晰 | 描述行为和预期 | 🟢 建议 |

---

## 后端专项检查

### 架构规范

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| Controller 无业务逻辑 | 只做路由、DTO、调用 Service | 🔴 阻塞 |
| common/ 无业务依赖 | 禁止 import modules/ | 🔴 阻塞 |
| 写操作可审计 | 走 Prisma 自动审计 | 🔴 阻塞 |
| 直接读 process.env | 必须用 AppConfigService | 🔴 阻塞 |

### API 规范

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 有 Swagger 注解 | @ApiTags, @ApiOperation, @ApiOkResponse | 🔴 阻塞 |
| DTO 使用 Zod | 中文错误消息 | 🔴 阻塞 |
| 错误码集中定义 | 使用 error-codes.ts | 🟡 建议修复 |
| 分页格式统一 | data + meta 结构 | 🔴 阻塞 |

### 数据库规范

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 表结构变更有 migration | prisma/migrations/ | 🔴 阻塞 |
| 软删用显式方法 | 不依赖 delete() 魔法 | 🔴 阻塞 |
| 金额用 Decimal | 禁止 Float | 🔴 阻塞 |
| 事务边界正确 | 一致性操作用 $transaction | 🟡 建议修复 |

---

## 前端专项检查

### React 规范

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 组件有 TypeScript 类型 | Props 接口定义 | 🔴 阻塞 |
| 无内联样式 | 使用 Tailwind | 🟡 建议修复 |
| 状态管理正确 | 服务端数据用 Query，UI 用 Zustand | 🟡 建议修复 |
| 无未处理的 Promise | async 函数正确 await | 🔴 阻塞 |

### 性能检查

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 大组件已拆分 | 避免单文件 > 300 行 | 🟡 建议修复 |
| 列表有 key | 唯一且稳定的 key | 🔴 阻塞 |
| 避免不必要重渲染 | 合理使用 memo/useMemo | 🟢 建议 |

---

## 小程序专项检查

| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 使用 Taro 组件 | View/Text，非 div/span | 🔴 阻塞 |
| 样式用 rpx | 750 设计稿 | 🟡 建议修复 |
| 页面配置完整 | index.config.ts | 🟡 建议修复 |

---

## 拒绝合并清单

以下情况**必须拒绝合并**，无例外：

| 情况 | 原因 |
|------|------|
| 出现 `console.log` | 必须用 Logger |
| 无解释的 `as any` | 类型安全 |
| Controller 写业务逻辑 | 分层职责 |
| 直接读取 `process.env` | 必须用 ConfigService |
| 魔法数字/字符串 | 可维护性 |
| 表结构变更无 migration | 数据库管理 |
| 导出接口用超大 limit | 性能风险 |
| 金额用 Float | 精度问题 |
| 敏感信息硬编码 | 安全风险 |
| CI 检查失败 | 质量底线 |

---

## 反馈规范

### 好的反馈

```markdown
🟡 建议：这个函数有点长（80行），建议拆分成 validateInput() 和 processData() 两个函数，提高可读性。

🔴 阻塞：这里直接读取了 process.env.JWT_SECRET，需要改用 AppConfigService。
参考：src/config/app-config.service.ts
```

### 避免

```markdown
❌ 这代码写得不好
❌ 为什么要这样写？
❌ 改一下
```

---

## 审查时间要求

| 类型 | 响应时间 | 说明 |
|------|----------|------|
| 紧急修复 | 4h 内 | 生产问题修复 |
| 普通 PR | 24h 内 | 首次响应 |
| 大型 PR | 48h 内 | > 500 行变更 |

**建议**：大型变更应拆分为多个小 PR

# 小红书数据集成模块

> 创建日期: 2025-12-26
> 状态: Phase 5 完成
> 负责人: -

## 概述

从 `api_54kb` 项目迁移小红书直播数据管理功能到本项目，并进行架构重构。该模块将提供小红书直播相关的数据代理、数据同步和数据查询能力。

## 需求背景

### 迁移来源

原系统 `api_54kb` 是一个基于 Express.js + Sequelize 的小红书直播数据管理系统，包含以下功能：

| 模块 | 功能 | 文件数 |
|------|------|--------|
| 直播管理 | 实时直播数据、操作直播间（讲解、弹窗等） | 3 |
| 商品管理 | CPS商品列表、商品详情 | 4 |
| 订单管理 | 订单查询、佣金统计 | 4 |
| 直播统计 | 历史直播数据、复盘分析 | 4 |
| 抽奖管理 | 抽奖列表、中奖用户 | 3 |
| Cookie管理 | 认证信息存储与获取 | 2 |
| 签名工具 | X-s/X-t 签名生成 | 2 |

**原系统问题**：

1. **认证管理混乱**：多种 Cookie 类型分散存储，获取逻辑重复
2. **代码重复严重**：每个 Service 都有 `getLatestLoginData()`、请求头构建等重复代码
3. **硬编码**：`host_id` 写死，不支持多账号
4. **职责不清**：混合了「实时 API 代理」和「数据存储分析」两种职责
5. **过度存储**：存储大量原始 JSON 数据，实际上可以实时获取

### 与配置中心的关系

Cookie 认证数据将存储在配置中心的 `script-data` 命名空间中，由油猴脚本通过 ScriptUpload 接口上传。数据结构示例：

```json
{
  "origin": "https://www.xiaohongshu.com",
  "hostname": "www.xiaohongshu.com",
  "deviceId": "xxx",
  "accountTag": "default",
  "accountName": "默认账号",
  "timestamp": 1766673897568,
  "cookies": [...],
  "cookieObj": {
    "a1": "xxx",
    "web_session": "xxx",
    "access-token-redlive.xiaohongshu.com": "xxx",
    ...
  }
}
```

## 核心设计理念

### 1. 代理优于存储

小红书数据实时性强，对于实时操作类功能（直播控制、商品查询等），做好 API 代理即可，不需要本地存储。

### 2. 聚合优于原始

对于需要存储的数据（订单、直播统计），只存储分析后的关键指标，不存储完整的原始 JSON。

### 3. 统一优于分散

认证、签名、请求都收敛到统一的服务层，避免代码重复。

### 4. 配置优于硬编码

账号信息全部走配置中心，支持多账号动态切换。

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        前端应用                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       XHS Module                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │
│  │   Auth       │  │    Proxy     │  │   DataSync       │   │
│  │  (认证管理)   │  │  (实时代理)   │  │  (数据同步)       │   │
│  └──────────────┘  └──────────────┘  └──────────────────┘   │
│         │                  │                  │              │
│         ▼                  │                  ▼              │
│  ┌──────────────┐          │          ┌──────────────┐       │
│  │ script-data  │          │          │  本地数据库   │       │
│  │ (配置中心)    │          │          │ (订单/直播)   │       │
│  └──────────────┘          │          └──────────────┘       │
│                            │                                 │
└────────────────────────────│─────────────────────────────────┘
                             │
                             ▼
                   ┌─────────────────┐
                   │  小红书官方 API  │
                   └─────────────────┘
```

### 模块职责

| 模块 | 职责 | 数据流向 |
|------|------|---------|
| **Auth** | 从配置中心获取 Cookie，管理多账号，检测过期 | 配置中心 → 内存缓存 |
| **Proxy** | 实时操作（讲解商品、弹窗、查询等），签名 + 转发 | 前端 → 代理 → 小红书 |
| **DataSync** | 定时/手动拉取数据到本地，增量同步 | 小红书 → 本地库 |
| **Data** | 查询本地存储的历史数据 | 本地库 → 前端 |

## 数据存储策略

### 必须存储的数据

| 数据类型 | 原因 | 同步策略 |
|----------|------|---------|
| **订单数据** | 佣金核算、退款追踪、财务记录；接口可能有时间窗口限制 | 增量同步，每小时拉取新订单；每天检查状态变更（退款） |
| **直播统计** | 复盘分析、趋势追踪；历史数据不可重新获取 | 直播结束后存储最终统计数据 |

### 不需要存储的数据

| 数据类型 | 原因 |
|----------|------|
| 商品列表 | 实时获取即可，变化频繁 |
| 实时直播数据 | 仅直播中有效，直播结束后无意义 |
| 直播间操作 | 纯操作类，无需存储 |

## 核心功能需求

### 1. 认证管理

- [ ] 从 `script-data` 命名空间获取 Cookie 配置
- [ ] 支持多账号管理（通过不同的 key 区分，如 `xhs-cookies-default`、`xhs-cookies-backup`）
- [ ] Cookie 过期检测与预警
- [ ] 内存缓存（5分钟），减少配置中心访问

### 2. API 代理

- [ ] 统一的请求签名服务（X-s、X-t 生成）
- [ ] 统一的请求头构建
- [ ] 统一的错误处理（Cookie 失效、接口变更等）
- [ ] 支持指定账号发起请求

### 3. 订单同步

- [ ] 增量同步：记录水位，只拉取新订单
- [ ] 状态追踪：定期检查未完成订单的状态变更（退款）
- [ ] 定时任务：每小时同步新订单，每天检查状态更新
- [ ] 手动触发：支持指定时间范围的手动同步

### 4. 直播统计同步

- [ ] 直播结束后自动拉取统计数据
- [ ] 支持手动触发同步
- [ ] 存储关键指标（时长、观看、销售额、佣金等）

### 5. 数据查询

- [ ] 订单列表查询（支持时间、状态、直播场次等筛选）
- [ ] 订单统计（佣金汇总、销售额汇总）
- [ ] 直播统计查询
- [ ] 按直播场次汇总订单

## 验收标准

### 基础功能

- [ ] 完成数据库模型设计与迁移
- [ ] 实现 `XhsAuthService`：Cookie 获取、多账号、过期检测
- [ ] 实现 `XhsSignatureService`：X-s/X-t 签名生成
- [ ] 实现 `XhsProxyService`：统一请求封装
- [ ] 实现 `XhsProxyController`：代理接口
- [ ] 实现 `XhsOrderSyncService`：订单增量同步
- [ ] 实现 `XhsLiveSyncService`：直播统计同步
- [ ] 实现 `XhsSyncScheduler`：定时同步任务
- [ ] 实现 `XhsOrderService` + Controller：订单查询
- [ ] 实现 `XhsLiveStatsService` + Controller：直播统计查询
- [ ] 添加错误码到 `error-codes.ts`（17000-17999）

### 同步可靠性

- [ ] 水位记录：记录同步进度，避免重复/遗漏
- [ ] 原始数据保底：`rawData` 字段存储原始 JSON，防止字段遗漏
- [ ] 同步失败重试机制
- [ ] 同步状态查询接口

### 测试覆盖

- [ ] 单元测试：签名生成、Cookie 解析
- [ ] E2E 测试：代理接口、同步接口、查询接口
- [ ] Mock 测试：模拟小红书 API 响应

### 文档

- [ ] Swagger API 文档
- [ ] 油猴脚本对接指南（Cookie 数据格式）

## 相关文档

- [实现方案](./implementation_plan.md)
- [数据库设计](./schema.md)
- [API 设计](./api.md)

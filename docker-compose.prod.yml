# =============================================================================
# Docker Compose - 生产环境部署
# =============================================================================
# 部署步骤:
#   1. 在服务器上创建 /opt/monorepo-skeleton 目录
#   2. 复制此文件和 .env.prod 到服务器
#   3. 执行: docker-compose -f docker-compose.prod.yml up -d
#
# 更新部署:
#   docker-compose -f docker-compose.prod.yml pull
#   docker-compose -f docker-compose.prod.yml up -d
#
# 环境变量文件: .env.prod (必须存在)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Server API 服务
  # ---------------------------------------------------------------------------
  server:
    image: ${DOCKER_REGISTRY}/server:${IMAGE_TAG:-latest}
    container_name: monorepo-skeleton-server-prod
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-17200}:8100"
    environment:
      - NODE_ENV=production
      - PORT=8100
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - CONFIG_ENCRYPTION_KEY=${CONFIG_ENCRYPTION_KEY}
      - JWT_ACCESS_TTL=${JWT_ACCESS_TTL:-15m}
      - JWT_REFRESH_TTL=${JWT_REFRESH_TTL:-7d}
      - IDEMPOTENCY_TTL_SECONDS=${IDEMPOTENCY_TTL_SECONDS:-86400}
      - PRISMA_SLOW_QUERY_MS=${PRISMA_SLOW_QUERY_MS:-500}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:8100/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - monorepo-skeleton-network

  # ---------------------------------------------------------------------------
  # Admin Web 管理后台
  # ---------------------------------------------------------------------------
  admin-web:
    image: ${DOCKER_REGISTRY}/admin-web:${IMAGE_TAG:-latest}
    container_name: monorepo-skeleton-admin-web-prod
    restart: unless-stopped
    ports:
      - "${ADMIN_WEB_PORT:-17201}:80"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1/health",
        ]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - monorepo-skeleton-network

  # ---------------------------------------------------------------------------
  # WWW Web 移动端
  # ---------------------------------------------------------------------------
  www-web:
    image: ${DOCKER_REGISTRY}/www-web:${IMAGE_TAG:-latest}
    container_name: monorepo-skeleton-www-web-prod
    restart: unless-stopped
    ports:
      - "${WWW_WEB_PORT:-17202}:80"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1/health",
        ]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - monorepo-skeleton-network

networks:
  monorepo-skeleton-network:
    driver: bridge
